<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" type="text/css" href="style(2).css">
 </head>
 <body>
  <main>
   <section class="section" id="account-opning">
    <div class="container my-4 p-4 rounded">
     <div class="row">
      <div class="col-sm-4">
       <form>
        <h2 class="d-flex justify-content-center">Account Opening Form</h2>
        <div class="mb-3">
         <label for="fname" class="form-label">Full Name</label>
         <input type="text" id="fname" name="fname" class="form-control" placeholder="Enter your name" required/>
        </div>
        <div class="mb-3">
         <label for="opn_balance" class="form-label">Opening Balance</label>
         <select class="form-select" name="opn_balance" id="balance">
          <option value="1000">1000</option>
          <option value="3000">3000</option>
          <option value="5000">5000</option>
         </select>
        </div>
        <div class="mb-3">
         <label for="fname" class="form-label">Pin</label>
         <!-- <input type="password" id="pwd" name="pwd" class="form-control" placeholder="Enter pin" required> -->
         <input type="password" name="pincode" maxlength="4" id="pwd" pattern="\d{4}" class="form-control" placeholder="Enter pin" required/>
        </div>
        <div class="d-flex justify-content-center">
         <button type="submit" class="btn btn-primary d-block" id="create_account">Create Account</button>
        </div>
       </form>
      </div>
      <div class="col-sm-8">
       <h2 class="d-flex justify-content-center">User List</h2>
       <div class="table-responsive">
        <table class="table table-bordered table-striped overflow-y: hidden" id="myTable">
         <thead>
          <tr>
           <th>ID</th>
           <th>Name</th>
           <th>Balance</th>
           <th>Pin</th>
          </tr>
         </thead>
         <tbody id="user-table">
         </tbody>
        </table>
       </div>
      </div>
     </div>
    </div>
   </section>
   <section class="section" id="transaction">
    <div class="container my-4 p-4 rounded">
     <div class="row">
       <div class="col-sm-4">
        <form>
         <h2 class="d-flex justify-content-center">Transaction</h2>
         <div class="mb-3">
          <label class="form-label" for="person">From</label>
          <input id ="from" type="text" class="form-control" pattern="[0-9]+" placeholder="user-id">
         </div>
         <div class="mb-3">
          <label class="form-label" for="another_person">To</label>
          <input id ="to" type="text" class="form-control" pattern="[0-9]+" id = "content" placeholder="user-id">
         </div>
         <div class="mb-3">
          <label class="form-label" for="amount">Amount</label>
          <input id ="amount" type="text" class="form-control" pattern="[0-9]+">
         </div>
         <div class="mb-3">
          <label class="form-label" for="pin">Pin</label>
          <input id ="pin" type="password" class="form-control" name="pin">
         </div>
         <div class="mb-3 d-flex justify-content-center">
          <button id="make_transaction_btn" class="btn btn-primary d-block">Transfer </button>
         </div>
        </form>
       </div>
       <div class="col-sm-8">
        <h2 class="d-flex justify-content-center">Passbook</h2>
        <table class="table table-bordered table-striped overflow-y: hidden" id="myPassbook">
         <thead>
          <tr>
           <th>Amount</th>
           <th>Transfer to</th>
           <th>Transfer From</th>
           <!-- <th>Pin</th> -->
          </tr>
         </thead>
         <tbody id="passbook">
         </tbody>
        </table>
        <div>
         <pre id="content"></pre>
        </div>
       </div>
     </div>
    </div>
   </section>
  </main>
 </body>
 <script type="text/javascript">
  let users = [];
  let transferData = [];
  let myHtmlContent = "";
  const makePassbook = (event) => {
   event.preventDefault();
   console.log("Hello");
   myPassbook = "";
   // drawTransaction()
   users.forEach(drawTransaction);
   var pre = document.getElementById('passbook');
   pre.innerHTML = myPassbook;
  }
  const makeTransaction = (event) => {
   event.preventDefault();
   let transfer = {
    from: parseInt(document.getElementById('from').value),
    to: parseInt(document.getElementById('to').value),
    amount: parseInt(document.getElementById('amount').value),
    pin: document.getElementById('pin').value,
   };
   transferData.push(transfer);
   document.forms[0].reset();
   if(transfer.from===transfer.to){
    alert("You can't transfer amount yourself");
   };
   if(fromUserExist(transfer.from) && toUserExist(transfer.to)){
    if(validatePin(transfer.from, transfer.pin)){
     if(checkSufficientBalance(transfer.from, transfer.amount)){
      transferAmount(transfer.from,transfer.to, transfer.amount);
     }else{
      alert("Please make a deposit. Your account does not have sufficient funds");
     }
    }else{
     alert("Invalid Pin");
    }
   }else{
    alert("Unknown User")
   };
  };
  const addData = (event) => {
   event.preventDefault(); //to stop the form submitting
   var user = {
    id: users.length + 1,
    fullname: document.getElementById('fname').value,
    balance: parseInt(document.getElementById('balance').value),
    pwd: document.getElementById('pwd').value,
    transactions: []
   };
   if(user.fullname==null || user.fullname==""){
    alert("Name can't be blank");
    return false;
   }else if(user.pwd.length<4){
    alert("Pin must be 4 characters long.");
    return false;
   };
   users.push(user);
   document.forms[0].reset(); //to clear the form for the next entries
   myHtmlContent = "";
   users.forEach(drawUserTable);
   var tbody = document.getElementById('user-table');
   tbody.innerHTML = myHtmlContent;
  }
  document.addEventListener('DOMContentLoaded', ()=>{
   document.getElementById("create_account").addEventListener('click', addData);
  });
  document.addEventListener('DOMContentLoaded', ()=>{
   document.getElementById("make_transaction_btn").addEventListener('click',makeTransaction);
  });
  document.addEventListener('DOMContentLoaded', ()=>{
   document.querySelector('#myTable tbody').addEventListener('click', makePassbook);
  });
  function drawUserTable(user){
   myHtmlContent = myHtmlContent + "<tr data-id='"+user.id+"'><td>"+user.id+ "</td><td>"+ user.fullname + "</td><td>"+ user.balance +"</td><td>"+ user.pwd + "</td></tr>";
  }
  function drawTransaction(){
   console.log("hello");
   myPassbook = '';
   user = users.filter(x =>x.id=== user[0]["id"]);
   debugger
   // userId = userId - 1;
   var userId = user[0]["id"];
   myPassbook = myPassbook + users[userId].transactions;
   // myPassbook = '';
   // var item = users.find(x =>x.id===user.id);
   // // userId = userId - 1;
   // myPassbook = myPassbook + item.transactions;
  }
  // myPassbook = myPassbook +"<tr><td>"+ transaction.amount +"</td><td>"+ transaction.toId +"</td><td>"+ transaction.fromId +"</td></tr>";
  // myPassbook = myPassbook +"<tr><td>"+ transaction.amount +"</td><td>"+ transaction.toId +"</td><td>"+ transaction.fromId +"</td></tr>";
  // user = users[0];
  // transfer = transferData[0];
  // myPassbook = myPassbook + transfer.amount + " Rs transfer to " + toTransaction(transfer.to) + " from " + fromTransaction(transfer.from) + "\n";
  // function fromTransaction(fromId){
  // user = users.filter(x =>x.id=== fromId);
  // return user[0].fullname;
  // }
  // function toTransaction(toId){
  // user = users.filter(x =>x.id=== toId);
  // return user[0].fullname;
  // }
  function fromUserExist(fromId){
   return users.some(function (x) {
    returnx.id=== fromId;
   });
  }
  function toUserExist(toId){
   return users.some(function (x) {
    returnx.id=== toId;
   });
  }
  function checkSufficientBalance(fromId, withdrawAmount){
   user = users.filter(x =>x.id=== fromId);
   return withdrawAmount <= user[0].balance;
  }
  function validatePin(fromId, pin){
   user = users.filter(x =>x.id=== fromId);
   return user[0].pwd === pin;
  }
  function transferAmount(fromId, toId, amount){
   users = users.map(obj => {
    if (obj.id=== fromId) {
     leftBalance = obj.balance - amount;
     transaction = {fromId: fromId, toId: toId, amount: -amount}
     obj.transactions.push(transaction)
     return {...obj, balance: leftBalance };
    }
    if (obj.id=== toId){
     newBalance = obj.balance + amount;
     transaction = {fromId: fromId, toId: toId, amount: amount}
     obj.transactions.push(transaction)
     return {...obj, balance: newBalance };
    }
    return obj;
   });
   myHtmlContent = "";
   users.forEach(drawUserTable);
   var tbody = document.getElementById('user-table');
   tbody.innerHTML = myHtmlContent;
  }
 </script>
</html>